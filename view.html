<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Explorer - View Mode</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* (same as your original â€“ unchanged) */
    * { box-sizing:border-box; margin:0; padding:0; }
    /* ... all your styles ... */
  </style>
</head>
<body>
  <!-- (same HTML structure you provided) -->

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

 <script>
  // === CONFIG ===
  const CSV_URL = "homebased_businesses_upto5yrs.csv";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbxcMbeegpI8WJh9kWmcJVQy6tzvgjxmKB8nuusuLCcTuLZ3ZLVHmDZgNXKQsypfHUROyA/execc";

  let map, markersLayer, ringsLayer, allRecords = [], activeCenter = null;
  let ringConfig = {count:3, stepMiles:1}, savedAddresses = [], excludedIds = new Set(), showDataset = true;

  // === WAIT FOR DOM ===
  document.addEventListener("DOMContentLoaded", () => {
    if (sessionStorage.getItem('isAuthenticated') !== 'true') {
      window.location.href = 'login.html';
      return;
    }

    // Now safe to access DOM
    initMap();
    bindEvents();
    loadConfigFromGAS();
    loadCsvData();
  });

  function initMap() {
    map = L.map('map').setView([36.85, -76.35], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    markersLayer = L.layerGroup().addTo(map);
    ringsLayer = L.layerGroup().addTo(map);
  }

  function bindEvents() {
    // These will now work
    document.getElementById('adminToggle').addEventListener('click', () => {
      document.getElementById('adminPanel').classList.toggle('visible');
    });
    document.getElementById('closeAdminPanel').addEventListener('click', () => {
      document.getElementById('adminPanel').classList.remove('visible');
    });
    document.getElementById('logoutBtn').addEventListener('click', () => {
      sessionStorage.removeItem('isAuthenticated');
      sessionStorage.removeItem('role');
      window.location.href = 'login.html';
    });

    // Add all other event listeners here
    document.getElementById('saveRingConfigBtn').addEventListener('click', saveRingConfig);
    document.getElementById('toggleAddressesBtn').addEventListener('click', toggleDataset);
    // ... etc
  }

  // === REST OF YOUR FUNCTIONS BELOW ===
  function loadConfigFromGAS() { /* ... */ }
  function saveConfigToGAS() { /* ... */ }
  function loadCsvData() { /* ... */ }
  // ... etc
</script>
</body>
</html>
